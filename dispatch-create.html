<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>(주)동특 | 배차등록</title>
  <style>
    :root {
      --ink: #0e1a2b;
      --deep: #0f223d;
      --accent: #0b5fc1;
      --accent-2: #5aa7e6;
      --paper: #ffffff;
      --mist: #f4f6f9;
      --card: #ffffff;
      --line: rgba(15, 23, 42, 0.08);
      --shadow: 0 20px 50px rgba(12, 24, 42, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Malgun Gothic", "맑은 고딕", "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(900px 380px at 15% 0%, rgba(11, 95, 193, 0.08), transparent 65%),
        radial-gradient(700px 340px at 92% 5%, rgba(11, 95, 193, 0.08), transparent 60%),
        linear-gradient(180deg, #fbfbfd 0%, #f2f4f8 55%, #edf1f6 100%);
    }

    .layout {
      display: grid;
      grid-template-columns: 120px 1fr;
      min-height: 100vh;
    }

                .sidebar {
      width: 120px;
      background: #ffffff;
      border-right: 1px solid var(--line);
      padding: 10px 6px 8px;
      position: sticky;
      top: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .logo {
      width: 100px;
      height: auto;
      display: block;
      margin-bottom: 24px;
    }

            .menu {
      margin-top: 16px;
      display: grid;
      gap: 8px;
      flex: 1;
    }

            .menu a {
      height: 36px;
      line-height: 36px;
      text-align: center;
      text-decoration: none;
      color: var(--deep);
      padding: 0 10px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(15, 23, 42, 0.2);
      transition: background 150ms ease, border 150ms ease;
    }

    .menu a.active {
      background: rgba(11, 95, 193, 0.08);
      border-color: rgba(11, 95, 193, 0.2);
      color: var(--accent);
      font-weight: 600;
    }

    .menu a:hover {
      background: rgba(15, 23, 42, 0.04);
      border-color: rgba(15, 23, 42, 0.06);
    }

    .main {
      padding: 28px 32px 40px;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 24px;
      background: var(--accent);
      color: #ffffff;
      padding: 8px 18px;
      border-radius: 20px;
          min-height: 65px;      height: 65px;}

    .page-header h1 {
      margin: 0;
      font-size: 22px;
      color: #ffffff;
    }

    .card {
      background: var(--card);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
    }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: nowrap;
      overflow: hidden;
    }

    .date-filter {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: rgba(14, 26, 43, 0.6);
    }

    .date-control {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .date-btn {
      border: 1px solid rgba(11, 95, 193, 0.3);
      background: rgba(11, 95, 193, 0.1);
      color: var(--accent);
      border-radius: 999px;
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: 600;
      line-height: 1;
    }

    .date-btn:hover {
      background: rgba(11, 95, 193, 0.18);
    }

    .date-filter input {
      border: 1px solid rgba(15, 23, 42, 0.12);
      border-radius: 20px;
      padding: 6px 10px;
      font-size: 12px;
      font-family: inherit;
    }

    .weekday {
      font-size: 12px;
      color: rgba(14, 26, 43, 0.7);
      font-weight: 600;
      min-width: 34px;
      text-align: center;
    }

    .weekday.saturday {
      color: #0b5fc1;
    }

    .weekday.holiday {
      color: #c2252a;
    }

    .misc-note {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: rgba(14, 26, 43, 0.6);
      flex-wrap: wrap;
    }

    .misc-note input {
      border: 1px solid rgba(15, 23, 42, 0.12);
      border-radius: 20px;
      padding: 6px 10px;
      font-size: 12px;
      font-family: inherit;
      min-width: 120px;
    }

    .misc-inputs {
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
    }

    .meta-stack {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 320px;
    }

    .support-note {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: rgba(14, 26, 43, 0.6);
      flex-direction: column;
      align-items: flex-start;
    }

    .support-note select {
      border: 1px solid rgba(15, 23, 42, 0.12);
      border-radius: 20px;
      padding: 6px 10px;
      font-size: 12px;
      font-family: inherit;
      min-width: 180px;
    }

    .toolbar .actions {
      margin: 0;
    }

    .excel-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      table-layout: fixed;
    }

    .table-wrap {
      overflow: auto;
      max-width: 100%;
      padding-bottom: 10px;
    }

    .excel-table th,
    .excel-table td {
      border: 1px solid rgba(15, 23, 42, 0.12);
      padding: 3px 6px;
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
      position: relative;
    }

    .excel-table th {
      background: #f4f6fb;
      color: rgba(14, 26, 43, 0.7);
      font-size: 11px;
      letter-spacing: 0.04em;
      user-select: none;
    }

    .cell-input {
      width: 100%;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      font-size: 12px;
      font-family: inherit;
      padding: 2px 3px;
      outline: none;
      line-height: 1.2;
    }

    .stacked-field {
      display: grid;
      gap: 6px;
    }

    .stacked-field .cell-input {
      border: 1px solid rgba(15, 23, 42, 0.12);
      border-radius: 20px;
      padding: 2px 4px;
      background: #ffffff;
    }

    .task-edit {
      min-height: 22px;
      padding: 4px 6px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .task-toolbar {
      position: absolute;
      display: none;
      gap: 6px;
      padding: 6px 8px;
      background: #ffffff;
      border: 1px solid rgba(15, 23, 42, 0.12);
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(12, 24, 42, 0.12);
      z-index: 50;
      align-items: center;
      font-size: 12px;
    }

    .task-toolbar button,
    .task-toolbar select {
      border: 1px solid rgba(15, 23, 42, 0.2);
      background: #ffffff;
      border-radius: 8px;
      padding: 3px 6px;
      font-size: 12px;
      cursor: pointer;
      font-family: inherit;
    }

    .task-toolbar button.active {
      background: rgba(11, 95, 193, 0.12);
      border-color: rgba(11, 95, 193, 0.3);
      color: var(--accent);
      font-weight: 700;
    }


    select option.driver-picked {
      background: rgba(11, 95, 193, 0.2);
      color: #0b5fc1;
      font-weight: 600;
    }

    .col-resizer {
      position: absolute;
      top: 0;
      right: 0;
      width: 8px;
      height: 100%;
      cursor: col-resize;
      background: rgba(255, 255, 255, 0.9);
      z-index: 1;
    }

    .col-resizer:hover {
      background: rgba(11, 95, 193, 0.2);
    }

    .drag-handle {
      cursor: grab;
      text-align: center;
      color: rgba(14, 26, 43, 0.55);
      font-size: 12px;
    }

    tr.dragging {
      opacity: 0.4;
    }


    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 16px;
    }

    .actions button,
    .actions a {
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .primary {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 10px 24px rgba(11, 95, 193, 0.25);
    }

    .ghost {
      background: rgba(15, 23, 42, 0.06);
      color: var(--deep);
    }

    .meta {
      font-size: 12px;
      color: rgba(14, 26, 43, 0.6);
      margin-top: 10px;
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 120px 1fr;
      }

                  .sidebar {
      background: #ffffff;
      border-right: 1px solid var(--line);
      padding: 10px 6px 8px;
      position: sticky;
      top: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

              .menu {
      display: grid;
      gap: 8px;
      flex: 1;
    }

      .main {
        padding: 22px 18px 32px;
      }

      .field {
        grid-column: span 12;
      }
    }
    /* Pebble header */    .page-header {      background: var(--accent);      color: #ffffff;      padding: 8px 18px;      border-radius: 20px;      min-height: 65px;      height: 65px;      box-shadow: none;    }

    .page-header h1 {
      color: #ffffff;
    }
    .header-actions {
      display: inline-flex;
      gap: 8px;
    }

    .logout-btn {
      border: 1px solid rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.16);
      color: #ffffff;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.28);
    }    /* Unified header size */    .page-header {      min-height: 65px;      height: 65px;      padding: 8px 18px;    }    .topbar {      min-height: 65px;      height: 65px;      padding: 8px 18px;    }  
    /* Mobile layout */
    @media (max-width: 720px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .sidebar {
        width: 100%;
        height: auto;
        position: static;
        flex-direction: row;
        align-items: center;
        gap: 8px;
        overflow-x: hidden;
        padding: 10px;
        flex-wrap: wrap;
      }

      .sidebar-footer {
        display: none;
      }

      .logo {
        width: 80px;
        margin: 0 8px 0 0;
      }

      .menu {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .menu a {
        white-space: nowrap;
        font-size: 12px;
        height: 32px;
      }

      .main {
        padding: 18px 14px 28px;
      }

      .table-wrap {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .card {
        border-radius: 16px;
        padding: 14px;
      }

      .page-header,
      .topbar {
        flex-wrap: wrap;
        gap: 10px;
        height: auto;
        min-height: 0;
      }
    }
  
    
    
    /* Unified mobile sidebar menu */
    @media (max-width: 720px) {
      .layout {
        display: flex !important;
        flex-direction: column !important;
        min-height: 0 !important;
        width: 100% !important;
      }

      .sidebar {
        width: 100% !important;
        height: auto !important;
        min-height: 0 !important;
        position: static !important;
        top: auto !important;
        flex-direction: column !important;
        align-items: stretch !important;
        justify-content: flex-start !important;
        gap: 4px !important;
        overflow-x: hidden !important;
        padding: 6px !important;
        flex-wrap: wrap !important;
      }

      .sidebar-footer {
        display: none !important;
      }

      .logo {
        width: 54px !important;
        margin: 0 !important;
      }

      .menu {
        display: grid !important;
        grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
        gap: 2px !important;
        margin-top: 2px !important;
        width: 100% !important;
        flex: 0 0 auto !important;
        align-content: start !important;
        grid-auto-rows: 18px !important;
      }

      .menu a {
        white-space: normal !important;
        font-size: 8px !important;
        height: 18px !important;
        line-height: 1 !important;
        padding: 0 1px !important;
        border-radius: 8px !important;
      }

      .main {
        width: 100% !important;
        padding: 6px 8px 12px !important;
      }

      .page-header,
      .topbar {
        flex-wrap: wrap !important;
        gap: 8px !important;
        height: auto !important;
        min-height: 0 !important;
        padding: 6px 12px !important;
      }

      .page-header {
        margin-bottom: 8px !important;
      }

      .controls {
        margin-bottom: 8px !important;
      }
    }
    /* role-menu-guard */
    body:not(.is-admin) .menu a[href="register-info.html"],
    body:not(.is-admin) .menu a[href="dispatch-create.html"],
    body:not(.is-admin) .menu a[href="office-work.html"] {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <a href="second.html"><img class="logo" src="Dongteuk.png" alt="(주)동특 로고" /></a>
      <nav class="menu" aria-label="주요 메뉴">
        <a href="second.html">&#50629;&#47924;&#54788;&#54889;</a>
        <a href="notice.html">공지사항</a>
        <a class="active" href="dispatch.html">배차현황</a>
        <a href="report.html">기사업무</a>
        <a href="office-work.html">&#49324;&#47924;&#50629;&#47924;</a>
        <a href="register-info.html">등록정보</a>
        <a href="settings.html">설정</a>
            
      </nav>
<div class="sidebar-footer">
        <div class="login-meta">
          <span id="login-user">-</span>
          <span id="login-time">-</span>
        </div>
      </div></aside>

    <main class="main">
      <header class="page-header">
        <h1>배차등록</h1>
          <div class="header-actions">
      <button class="logout-btn" type="button" onclick="history.back()">뒤로가기</button>
      <button class="logout-btn" type="button" onclick="localStorage.removeItem('dongteukCurrentUser'); localStorage.removeItem('dongteukCurrentRole'); location.href='/logout'">로그아웃</button>
    </div></header>

      <section class="card">
        <div class="toolbar">
          <div class="meta-stack">
            <div class="meta" id="off-list">휴무자: -</div>
            <div class="misc-note">
              <label for="misc-note-1">기타 사항</label>
              <div class="misc-inputs">
                <input id="misc-note-1" class="misc-input" type="text" placeholder="기타사항 1" />
                <input id="misc-note-2" class="misc-input" type="text" placeholder="기타사항 2" />
                <input id="misc-note-3" class="misc-input" type="text" placeholder="기타사항 3" />
                <input id="misc-note-4" class="misc-input" type="text" placeholder="기타사항 4" />
              </div>
            </div>
          </div>
          <div class="support-note">
            <select id="support-phone">
              <option value="">전화응대 선택</option>
            </select>
            <select id="support-system">
              <option value="">전산응대 선택</option>
            </select>
          </div>
          <div class="date-filter">
            <div class="date-control">
              <button class="date-btn" type="button" id="date-prev" aria-label="이전 날짜">&#x2039;</button>
              <input id="dispatch-date" type="date" />
              <button class="date-btn" type="button" id="date-next" aria-label="다음 날짜">&#x203A;</button>
            </div>
            <span class="weekday" id="dispatch-weekday"></span>
          </div>
        </div>

        <div class="table-wrap">
          <table class="excel-table" id="dispatch-table">
            <colgroup>
              <col style="width: 30px;" />
              <col style="width: 60px;" />
              <col style="width: 54px;" />
              <col style="width: 120px;" />
              <col style="width: 64px;" />
              <col style="width: 54px;" />
              <col style="width: 80px;" />
              <col style="width: 90px;" />
              <col style="width: 90px;" />
              <col style="width: 80px;" />
              <col style="width: 80px;" />
              <col style="width: 100%;" />
              <col style="width: 90px;" />
            </colgroup>
            <thead>
              <tr>
                <th>↕</th>
                <th>Product</th>
                <th>Size</th>
                <th>차량번호</th>
                <th>LB Cods</th>
                <th>Vol</th>
                <th>트랙터</th>
                <th>특징</th>
                <th>전일사입</th>
                <th>Driver</th>
                <th>출발시간</th>
                <th>작업</th>
                <th>최종사입</th>
              </tr>
            </thead>
            <tbody id="dispatch-body"></tbody>
          </table>
        </div>

        <div class="actions" style="margin-top: 10px;">
          <button class="ghost" type="button" id="add-row">행 추가</button>
          <button class="ghost" type="button" id="clear-all">전체 삭제</button>
          <a class="ghost" href="#" onclick="history.back(); return false;">뒤로가기</a>
          <button class="primary" type="button" id="save-dispatch">등록</button>
        </div>
        <div class="meta">등록 시 입력한 데이터가 저장되고 배차현황에 반영됩니다.</div>
      </section>
    </main>
  </div>
  <div class="task-toolbar" id="task-toolbar">
    <button type="button" id="task-bold">B</button>
    <select id="task-color">
      <option value="">글자색</option>
      <option value="#0e1a2b">검정</option>
      <option value="#0b5fc1">파랑</option>
      <option value="#1f7a54">초록</option>
      <option value="#c2252a">빨강</option>
    </select>
  </div>
  <script src="data-sync.js"></script>
  <script>
    const columns = [
      "product",
      "size",
      "vehicle",
      "lb",
      "vol",
      "tractor",
      "availability",
      "prevday",
      "driver",
      "departTime",
      "task",
      "finalPurchase",
    ];

    const body = document.getElementById("dispatch-body");
    const storageKey = "dongteukDispatches";
    const metaKey = "dongteukDispatchMeta";
    const draftKey = "dongteukDispatchDrafts";
    const draftLastKey = "dongteukDispatchDraftLast";

    const readDrivers = () => {
      try {
        return JSON.parse(localStorage.getItem("dongteukDrivers") || "[]");
      } catch (error) {
        return [];
      }
    };

    const getCurrentUser = () => (localStorage.getItem("dongteukCurrentUser") || "").trim();

    const enforceAdminAccess = () => {
      const currentUser = getCurrentUser();
      if (!currentUser) {
        alert("관리자만 접근 가능합니다.");
        window.location.href = "main.html";
        return false;
      }
      const drivers = readDrivers();
      const found = drivers.find((item) => (item.name || "").trim() === currentUser);
      if (!found || found.status !== "관리자") {
        alert("관리자만 접근 가능합니다.");
        window.location.href = "second.html";
        return false;
      }
      return true;
    };

    enforceAdminAccess();

    const normalizeDispatches = (value) => {
      if (Array.isArray(value)) return value;
      if (typeof value === "string") {
        const trimmed = value.trim();
        if (!trimmed) return null;
        try {
          const parsed = JSON.parse(trimmed);
          return Array.isArray(parsed) ? parsed : null;
        } catch (error) {
          return null;
        }
      }
      return null;
    };

    const readDispatches = () => {
      const raw = localStorage.getItem(storageKey);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        const normalized = normalizeDispatches(parsed);
        if (normalized && raw.trim().startsWith("'")) {
          localStorage.setItem(storageKey, JSON.stringify(normalized));
        }
        return normalized || [];
      } catch (error) {
        const trimmed = raw.trim();
        const hasQuotes =
          (trimmed.startsWith("'") && trimmed.endsWith("'")) ||
          (trimmed.startsWith("\"") && trimmed.endsWith("\""));
        if (!hasQuotes) return [];
        try {
          const parsed = JSON.parse(trimmed.slice(1, -1));
          const normalized = normalizeDispatches(parsed);
          if (normalized) {
            localStorage.setItem(storageKey, JSON.stringify(normalized));
          }
          return normalized || [];
        } catch (innerError) {
          return [];
        }
      }
    };
    const dateInput = document.getElementById("dispatch-date");
    const weekdayLabel = document.getElementById("dispatch-weekday");
    const prevBtn = document.getElementById("date-prev");
    const nextBtn = document.getElementById("date-next");
    const offList = document.getElementById("off-list");
    const miscInputs = [
      document.getElementById("misc-note-1"),
      document.getElementById("misc-note-2"),
      document.getElementById("misc-note-3"),
      document.getElementById("misc-note-4"),
    ];
    const supportPhone = document.getElementById("support-phone");
    const supportSystem = document.getElementById("support-system");
    const readVehicles = () => {
      const raw = localStorage.getItem("dongteukVehicles");
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch (error) {
        return [];
      }
    };

    const writeVehicles = (list) => {
      localStorage.setItem("dongteukVehicles", JSON.stringify(list));
      new BroadcastChannel("dongteuk-sync").postMessage({ key: "dongteukVehicles" });
    };

    const updateVehicleFeature = (number, feature) => {
      if (!number) return;
      const list = readVehicles();
      const index = list.findIndex((item) => item.number === number);
      if (index < 0) return;
      list[index].feature = feature || "";
      writeVehicles(list);
    };

    const getMiscNotes = () =>
      miscInputs.map((input) => (input ? input.value.trim() : ""));

    const setMiscNotes = (notes) => {
      miscInputs.forEach((input, index) => {
        if (!input) return;
        input.value = notes[index] || "";
      });
    };

    const getMiscNames = () => {
      const values = getMiscNotes();
      const names = [];
      values.forEach((value) => {
        value
          .split(/[,\u002f]/)
          .map((item) => item.trim())
          .filter(Boolean)
          .forEach((item) => {
            const parts = item
              .split(/[:：]/)
              .map((part) => part.trim())
              .filter(Boolean);
            if (parts.length > 1) {
              names.push(parts[parts.length - 1]);
            } else {
              names.push(item);
            }
          });
      });
      return names;
    };

    const readAdmins = () => {
      const raw = localStorage.getItem("dongteukDrivers");
      if (!raw) return [];
      try {
        return JSON.parse(raw)
          .filter((item) => item.status === "관리자")
          .map((item) => item.name)
          .filter(Boolean);
      } catch (error) {
        return [];
      }
    };

    const fillSupportAdmins = () => {
      const admins = readAdmins();
      if (supportPhone instanceof HTMLSelectElement) {
        const current = supportPhone.value;
        supportPhone.innerHTML = "<option value=\"\">전화응대 선택</option>";
        admins.forEach((name) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          if (name === current) option.selected = true;
          supportPhone.appendChild(option);
        });
      }
      if (supportSystem instanceof HTMLSelectElement) {
        const current = supportSystem.value;
        supportSystem.innerHTML = "<option value=\"\">전산응대 선택</option>";
        admins.forEach((name) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          if (name === current) option.selected = true;
          supportSystem.appendChild(option);
        });
      }
    };


    const normalizeProduct = (value) => {
      if (!value) return "";
      const upper = value.toUpperCase();
      if (upper === "LIN" || upper === "LOX" || upper === "LAR") return upper;
      if (value === "산소") return "LOX";
      if (value === "질소") return "LIN";
      if (value === "알곤") return "LAR";
      return value;
    };

    const buildVehicleOptions = (product) => {
      const vehicles = readVehicles();
      const normalizedProduct = normalizeProduct(product);
      const filtered = vehicles.filter((item) => {
        if (!normalizedProduct) return true;
        const matchesProduct = normalizeProduct(item.product || "") === normalizedProduct;
        const usable = item.status ? item.status !== "미사용" : true;
        return matchesProduct && usable;
      });

      return filtered.map((item) => {
        const number = item.number || "";
        return {
          value: number,
          label: number,
          data: item,
        };
      });
    };

    const setRowField = (row, field, value) => {
      const input = row.querySelector(`[data-field="${field}"]`);
      if (!input) return;
      if (input instanceof HTMLElement && input.isContentEditable) {
        input.innerHTML = value || "";
        return;
      }
      input.value = value || "";
    };

    const fillVehicleData = (row, vehicle) => {
      if (!vehicle) return;
      setRowField(row, "size", vehicle.size);
      setRowField(row, "lb", vehicle.lb);
      setRowField(row, "vol", vehicle.vol);
      setRowField(row, "tractor", vehicle.type);
    };

    const updateVehicleOptions = (row) => {
      const product = row.querySelector('[data-field="product"]')?.value || "";
      const vehicleSelect = row.querySelector('[data-field="vehicle"]');
      const tractorSelect = row.querySelector('[data-field="tractor"]');
      const driverSelect = row.querySelector('[data-field="driver"]');
      if (!(vehicleSelect instanceof HTMLSelectElement)) return;
      const pickedTractors = new Set(
        Array.from(document.querySelectorAll('[data-field="tractor"]'))
          .map((el) => (el instanceof HTMLSelectElement ? el.value : ""))
          .filter(Boolean)
      );

      const currentValue = vehicleSelect.value;
      const options = buildVehicleOptions(product);
      vehicleSelect.innerHTML = "";

      const emptyOption = document.createElement("option");
      emptyOption.value = "";
      emptyOption.textContent = "선택";
      vehicleSelect.appendChild(emptyOption);

      options.forEach((optionData) => {
        const option = document.createElement("option");
        option.value = optionData.value;
        option.textContent = optionData.label || optionData.value;
        if (optionData.value === currentValue) {
          option.selected = true;
        }
        vehicleSelect.appendChild(option);
      });

      const selected = options.find((item) => item.value === vehicleSelect.value);
      fillVehicleData(row, selected?.data);
      const availabilityInput = row.querySelector('[data-field="availability"]');
      if (availabilityInput instanceof HTMLInputElement) {
        availabilityInput.value = selected?.data?.feature || "";
      }

      if (tractorSelect instanceof HTMLSelectElement) {
        const isChassis = (selected?.data?.type || "") === "샤시";
        tractorSelect.innerHTML = "";
        const emptyOption = document.createElement("option");
        emptyOption.value = "";
        emptyOption.textContent = isChassis ? "선택" : "해당 없음";
        tractorSelect.appendChild(emptyOption);
        tractorSelect.disabled = !isChassis;
        if (isChassis) {
          const tractors = readVehicles().filter((item) => item.type === "트랙터" && item.status !== "미사용");
          tractors.forEach((tractor) => {
            const option = document.createElement("option");
            option.value = tractor.number || "";
            option.textContent = tractor.lb ? `${tractor.number} (${tractor.lb})` : tractor.number || "";
            if (pickedTractors.has(option.value)) {
              option.classList.add("driver-picked");
            }
            tractorSelect.appendChild(option);
          });
        }
      }

      if (driverSelect instanceof HTMLSelectElement) {
        const drivers = JSON.parse(localStorage.getItem("dongteukDrivers") || "[]")
          .filter((item) => (item.status || "근무") === "근무")
          .map((item) => item.name)
          .filter(Boolean);
        const picked = new Set(
          Array.from(document.querySelectorAll('[data-field="driver"]'))
            .map((el) => (el instanceof HTMLSelectElement ? el.value : ""))
            .filter(Boolean)
        );
        const current = driverSelect.value;
        driverSelect.innerHTML = "";
        const emptyOption = document.createElement("option");
        emptyOption.value = "";
        emptyOption.textContent = "선택";
        driverSelect.appendChild(emptyOption);
        drivers.forEach((name) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          if (picked.has(name)) {
            option.classList.add("driver-picked");
          }
          if (name === current) {
            option.selected = true;
          }
          driverSelect.appendChild(option);
        });
      }
    };

    const updateDriverDuplicates = () => {
      const selections = Array.from(document.querySelectorAll('[data-field="driver"]'))
        .map((el) => (el instanceof HTMLSelectElement ? el.value : ""))
        .filter(Boolean);
      const counts = selections.reduce((map, name) => {
        map[name] = (map[name] || 0) + 1;
        return map;
      }, {});

      document.querySelectorAll("#dispatch-body tr").forEach((row) => {
        const select = row.querySelector('[data-field="driver"]');
        const input = row.querySelector('[data-field="driverDuplicate"]');
        if (!(select instanceof HTMLSelectElement) || !(input instanceof HTMLInputElement)) return;
        const duplicated = select.value && counts[select.value] > 1;
        input.disabled = !duplicated;
        input.style.display = duplicated ? "block" : "none";
        if (!duplicated) {
          input.value = "";
        }
      });
    };

    const addRow = (values = []) => {
      const row = document.createElement("tr");
      row.draggable = false;
      const handleCell = document.createElement("td");
      handleCell.className = "drag-handle";
      handleCell.textContent = "??";
      handleCell.draggable = true;
      row.appendChild(handleCell);
      columns.forEach((key, index) => {
        const cell = document.createElement("td");
        if (key === "product") {
          const select = document.createElement("select");
          select.className = "cell-input";
          select.dataset.field = key;
          ["", "LIN", "LOX", "LAR"].forEach((optionValue) => {
            const option = document.createElement("option");
            option.value = optionValue;
            option.textContent = optionValue || "선택";
            if (optionValue && optionValue === values[index]) {
              option.selected = true;
            }
            select.appendChild(option);
          });
          cell.appendChild(select);
        } else if (key === "vehicle") {
          const select = document.createElement("select");
          select.className = "cell-input";
          select.dataset.field = key;
          cell.appendChild(select);
        } else if (key === "tractor") {
          const select = document.createElement("select");
          select.className = "cell-input";
          select.dataset.field = key;
          cell.appendChild(select);
        } else if (key === "prevday" || key === "finalPurchase") {
          const wrapper = document.createElement("div");
          wrapper.className = "stacked-field";

          const select = document.createElement("select");
          select.className = "cell-input";
          select.dataset.field = key;
          [
            "공차",
            "탕정",
            "평택",
            "냉열",
            "기흥",
            "구미",
            "울산",
            "기타직접입력",
          ].forEach((value) => {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
          });

          const custom = document.createElement("input");
          custom.className = "cell-input";
          custom.placeholder = "기타 입력";
          custom.dataset.field = key === "prevday" ? "prevdayCustom" : "finalPurchaseCustom";
          custom.disabled = true;
          custom.style.display = "none";

          wrapper.appendChild(select);
          wrapper.appendChild(custom);
          cell.appendChild(wrapper);
        } else if (key === "driver") {
          const wrapper = document.createElement("div");
          wrapper.className = "stacked-field";

          const select = document.createElement("select");
          select.className = "cell-input";
          select.dataset.field = key;

          const duplicate = document.createElement("input");
          duplicate.className = "cell-input";
          duplicate.placeholder = "중복 메모";
          duplicate.dataset.field = "driverDuplicate";
          duplicate.disabled = true;
          duplicate.style.display = "none";

          wrapper.appendChild(select);
          wrapper.appendChild(duplicate);
          cell.appendChild(wrapper);
        } else if (key === "departTime") {
          const select = document.createElement("select");
          select.className = "cell-input";
          select.dataset.field = key;
          const start = 4 * 60;
          const end = 24 * 60;
          for (let minutes = start; minutes <= end; minutes += 30) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            const label = `${String(hours).padStart(2, "0")}:${String(mins).padStart(2, "0")}`;
            const option = document.createElement("option");
            option.value = label;
            option.textContent = label;
            select.appendChild(option);
          }
          cell.appendChild(select);
        } else if (key === "task") {
          const input = document.createElement("div");
          input.className = "cell-input task-edit";
          input.contentEditable = "true";
          input.dataset.field = key;
          input.innerHTML = values[index] || "";
          cell.appendChild(input);
        } else if (key === "availability") {
          const input = document.createElement("input");
          input.className = "cell-input";
          input.placeholder = "특징";
          input.dataset.field = key;
          input.value = values[index] || "";
          cell.appendChild(input);
        } else {
          const input = document.createElement("input");
          input.className = "cell-input";
          input.value = values[index] || "";
          input.dataset.field = key;
          cell.appendChild(input);
        }
        row.appendChild(cell);
      });
      body.appendChild(row);

      const productSelect = row.querySelector('[data-field="product"]');
      if (productSelect) {
        productSelect.value = values[0] || "";
      }
      const prevdaySelect = row.querySelector('[data-field="prevday"]');
      if (prevdaySelect instanceof HTMLSelectElement) {
        prevdaySelect.value = values[7] || "공차";
        const custom = row.querySelector('[data-field="prevdayCustom"]');
        if (custom instanceof HTMLInputElement) {
          const useCustom = prevdaySelect.value === "기타직접입력";
          custom.disabled = !useCustom;
          if (useCustom) {
            custom.value = values[7] || "";
          }
        }
      }
      const finalPurchaseSelect = row.querySelector('[data-field="finalPurchase"]');
      if (finalPurchaseSelect instanceof HTMLSelectElement) {
        finalPurchaseSelect.value = values[11] || "공차";
        const custom = row.querySelector('[data-field="finalPurchaseCustom"]');
        if (custom instanceof HTMLInputElement) {
          const useCustom = finalPurchaseSelect.value === "기타직접입력";
          custom.disabled = !useCustom;
          if (useCustom) {
            custom.value = values[11] || "";
          }
        }
      }
      const availabilityInput = row.querySelector('[data-field="availability"]');
      if (availabilityInput instanceof HTMLInputElement) {
        availabilityInput.value = values[6] || "";
      }
      updateVehicleOptions(row);
      setRowField(row, "vehicle", values[2]);
      updateVehicleOptions(row);
      return row;
    };

    const addInitialRows = () => {
      for (let i = 0; i < 5; i += 1) {
        addRow();
      }
    };

    const fillRowFromData = (row, data) => {
      Object.entries(data).forEach(([field, value]) => {
        setRowField(row, field, value);
      });
      updateVehicleOptions(row);
      updateDriverDuplicates();
    };

    const readDrafts = () => {
      const raw = localStorage.getItem(draftKey);
      if (!raw) return {};
      try {
        return JSON.parse(raw) || {};
      } catch (error) {
        return {};
      }
    };

    const updateTractorHighlights = () => {
      const picked = new Set(
        Array.from(document.querySelectorAll('[data-field="tractor"]'))
          .map((el) => (el instanceof HTMLSelectElement ? el.value : ""))
          .filter(Boolean)
      );
      document.querySelectorAll('[data-field="tractor"]').forEach((select) => {
        if (!(select instanceof HTMLSelectElement)) return;
        Array.from(select.options).forEach((option) => {
          if (!option.value) {
            option.classList.remove("driver-picked");
            return;
          }
          if (picked.has(option.value)) {
            option.classList.add("driver-picked");
          } else {
            option.classList.remove("driver-picked");
          }
        });
      });
    };

    const sanitizeTaskHtml = (html) => {
      const template = document.createElement("template");
      template.innerHTML = html || "";
      template.content.querySelectorAll("script, style").forEach((node) => node.remove());
      template.content.querySelectorAll("*").forEach((node) => {
        Array.from(node.attributes).forEach((attr) => {
          if (attr.name.startsWith("on")) {
            node.removeAttribute(attr.name);
          }
        });
      });
      return template.innerHTML;
    };

    const getFieldValue = (input) => {
      if (input instanceof HTMLElement && input.isContentEditable) {
        return sanitizeTaskHtml(input.innerHTML.trim());
      }
      return input.value.trim();
    };

    const saveDraft = () => {
      if (!dateInput || !dateInput.value) return;
      const rows = Array.from(body.querySelectorAll("tr"));
      const draftRows = rows.map((row) => {
        const data = {};
        row.querySelectorAll("[data-field]").forEach((input) => {
          data[input.dataset.field] = getFieldValue(input);
        });
        return data;
      });
      const drafts = readDrafts();
      drafts[dateInput.value] = {
        rows: draftRows,
        miscNotes: getMiscNotes(),
        supportPhone: supportPhone ? supportPhone.value : "",
        supportSystem: supportSystem ? supportSystem.value : "",
      };
      localStorage.setItem(draftKey, JSON.stringify(drafts));
      localStorage.setItem(draftLastKey, dateInput.value);
    };

    const loadDraftForDate = (dateValue) => {
      if (!dateValue) return false;
      const drafts = readDrafts();
      const entry = drafts[dateValue];
      if (!entry || !Array.isArray(entry.rows)) {
        return false;
      }
      const hasData =
        entry.rows.some((row) => Object.values(row || {}).some((value) => value)) ||
        (Array.isArray(entry.miscNotes)
          ? entry.miscNotes.some((note) => note && note.trim())
          : entry.miscNote && entry.miscNote.trim());
      if (!hasData) {
        return false;
      }
      body.innerHTML = "";
      entry.rows.forEach((data) => {
        const row = addRow();
        fillRowFromData(row, data);
      });
      if (Array.isArray(entry.miscNotes)) {
        setMiscNotes(entry.miscNotes);
      } else if (entry.miscNote) {
        setMiscNotes([entry.miscNote]);
      } else {
        setMiscNotes([]);
      }
      if (supportPhone) {
        supportPhone.value = entry.supportPhone || "";
      }
      if (supportSystem) {
        supportSystem.value = entry.supportSystem || "";
      }
      return true;
    };

    const allowedPrevday = new Set([
      "공차",
      "탕정",
      "평택",
      "냉열",
      "기흥",
      "구미",
      "울산",
      "기타직접입력",
    ]);

    const getPreviousDateString = (value) => {
      const [year, month, day] = value.split("-").map(Number);
      const date = new Date(year, month - 1, day);
      date.setDate(date.getDate() - 1);
      return getLocalDateString(date);
    };

    const applyPrevdayFromPrevious = (dateValue) => {
      const previousDate = getPreviousDateString(dateValue);
      const all = readDispatches();
      const previousRows = all.filter((row) => {
        if (row.dispatchDate) return row.dispatchDate === previousDate;
        if (row.savedAt) return row.savedAt.startsWith(previousDate);
        return false;
      });
      if (!previousRows.length) return;
      const byVehicle = new Map();
      previousRows.forEach((row) => {
        const vehicle = (row.vehicle || "").trim();
        if (vehicle) {
          byVehicle.set(vehicle, row.finalPurchase || "");
        }
      });
      Array.from(body.querySelectorAll("tr")).forEach((row) => {
        const vehicle = (row.querySelector('[data-field="vehicle"]')?.value || "").trim();
        const finalValue = (byVehicle.get(vehicle) || "").trim();
        if (!finalValue) return;
        const prevdaySelect = row.querySelector('[data-field="prevday"]');
        const prevdayCustom = row.querySelector('[data-field="prevdayCustom"]');
        if (!(prevdaySelect instanceof HTMLSelectElement)) return;
        const currentPrevday = prevdaySelect.value;
        const currentCustom = prevdayCustom instanceof HTMLInputElement ? prevdayCustom.value.trim() : "";
        if (currentPrevday && currentPrevday !== "공차") return;
        if (currentPrevday === "기타직접입력" && currentCustom) return;
        if (allowedPrevday.has(finalValue)) {
          prevdaySelect.value = finalValue;
          if (prevdayCustom instanceof HTMLInputElement) {
            prevdayCustom.value = "";
            prevdayCustom.disabled = true;
            prevdayCustom.style.display = "none";
          }
        } else {
          prevdaySelect.value = "기타직접입력";
          if (prevdayCustom instanceof HTMLInputElement) {
            prevdayCustom.value = finalValue;
            prevdayCustom.disabled = false;
            prevdayCustom.style.display = "block";
          }
        }
      });
    };

    const resetForDate = () => {
      body.innerHTML = "";
      populateFromVehicles();
      updateDriverDuplicates();
      if (miscInputs.length) {
        setMiscNotes([]);
      }
      if (supportPhone) {
        supportPhone.value = "";
      }
      if (supportSystem) {
        supportSystem.value = "";
      }
    };

    const applyDateChange = (value) => {
      updateWeekday(value);
      if (!loadDraftForDate(value)) {
        resetForDate();
      }
      applyPrevdayFromPrevious(value);
    };

    const populateFromVehicles = () => {
      const vehicles = readVehicles().filter((item) => {
        const type = item.type || "";
        return item.status === "사용" && (type === "탱크로리" || type === "샤시");
      });
      if (!vehicles.length) {
        addInitialRows();
        return;
      }
      body.innerHTML = "";
      vehicles.forEach((item) => {
        addRow([
          item.product || "",
          item.size || "",
          item.number || "",
          item.lb || "",
          item.vol || "",
          "",
          "",
          "공차",
          "",
          "",
          "",
          "공차",
        ]);
      });
    };

    document.getElementById("add-row").addEventListener("click", () => {
      addRow();
      saveDraft();
    });
    document.getElementById("clear-all").addEventListener("click", () => {
      body.innerHTML = "";
      addInitialRows();
      saveDraft();
    });
    document.getElementById("save-dispatch").addEventListener("click", () => {
      const rows = Array.from(body.querySelectorAll("tr"));
      const vehicles = readVehicles();
      const payload = rows
        .map((row) => {
        const data = {};
        row.querySelectorAll("[data-field]").forEach((input) => {
          data[input.dataset.field] = getFieldValue(input);
        });
          if (data.prevday === "기타직접입력") {
            data.prevday = data.prevdayCustom || "";
          }
          if (!data.prevday) {
            data.prevday = "공차";
          }
          if (data.finalPurchase === "기타직접입력") {
            data.finalPurchase = data.finalPurchaseCustom || "";
          }
          if (!data.finalPurchase) {
            data.finalPurchase = "공차";
          }
          if (data.tractor) {
            const tractor = vehicles.find(
              (item) => item.type === "트랙터" && item.number === data.tractor
            );
            data.tractorLb = tractor && tractor.lb ? tractor.lb : "";
          } else {
            data.tractorLb = "";
          }
          const vehicleInfo = vehicles.find((item) => item.number === data.vehicle);
          data.vehicleType = vehicleInfo && vehicleInfo.type ? vehicleInfo.type : "";
          delete data.prevdayCustom;
          delete data.finalPurchaseCustom;
          data.dispatchDate = dateInput ? dateInput.value : "";
          return data;
        })
        .filter((row) => Object.values(row).some((value) => value));

      if (!payload.length) {
        alert("저장할 데이터가 없습니다.");
        return;
      }

      const existing = readDispatches();
      const selectedDate = dateInput ? dateInput.value : "";
      const saved = payload.map((row) => ({
        ...row,
        savedAt: new Date().toISOString(),
      }));
      const filteredExisting = selectedDate
        ? existing.filter((row) => row.dispatchDate !== selectedDate)
        : existing;
      localStorage.setItem(storageKey, JSON.stringify(filteredExisting.concat(saved)));
      const miscNotes = getMiscNotes();
      const miscNote = miscNotes.map((note) => note.trim()).filter(Boolean).join(" / ");
      let existingMeta = {};
      try {
        existingMeta = JSON.parse(localStorage.getItem(metaKey) || "{}");
      } catch (error) {
        existingMeta = {};
      }
      const nowStamp = new Date().toISOString();
      const createdAt =
        existingMeta.date === selectedDate && existingMeta.createdAt
          ? existingMeta.createdAt
          : nowStamp;
      const currentUser = getCurrentUser();
      let editorName = "";
      let editorTitle = "";
      if (currentUser) {
        try {
          const drivers = JSON.parse(localStorage.getItem("dongteukDrivers") || "[]");
          const found = drivers.find((item) => (item.name || "").trim() === currentUser);
          if (found) {
            editorName = found.name || "";
            editorTitle = found.title || "";
          }
        } catch (error) {
        }
      }
      localStorage.setItem(
        metaKey,
        JSON.stringify({
          date: selectedDate,
          offList: offList ? offList.textContent.replace("휴무자:", "").trim() : "",
          miscNote,
          miscNotes,
          supportPhone: supportPhone ? supportPhone.value : "",
          supportSystem: supportSystem ? supportSystem.value : "",
          createdAt,
          updatedAt: nowStamp,
          editorName,
          editorTitle,
        })
      );
      try {
        const miscKey = "dongteukMiscByDate";
        const miscMap = JSON.parse(localStorage.getItem(miscKey) || "{}");
        if (selectedDate) {
          miscMap[selectedDate] = miscNotes;
          localStorage.setItem(miscKey, JSON.stringify(miscMap));
        }
      } catch (error) {}
      try {
        const offKey = "dongteukOffByDate";
        const offMap = JSON.parse(localStorage.getItem(offKey) || "{}");
        if (selectedDate) {
          offMap[selectedDate] = offList ? offList.textContent.replace("???:", "").trim() : "";
          localStorage.setItem(offKey, JSON.stringify(offMap));
        }
      } catch (error) {}

      saveDraft();
      new BroadcastChannel("dongteuk-sync").postMessage({ key: storageKey });
      alert("배차등록이 저장되었습니다.");
      window.location.href = "dispatch.html?saved=1";
    });

    populateFromVehicles();
    fillSupportAdmins();
    updateDriverDuplicates();

    const getLocalDateString = (date = new Date()) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    };

    const holidays = new Set([
      "2026-01-01",
      "2026-03-01",
      "2026-05-05",
      "2026-06-06",
      "2026-08-15",
      "2026-10-03",
      "2026-10-09",
      "2026-12-25",
    ]);

    const updateWeekday = (value) => {
      if (!weekdayLabel) return;
      if (!value) {
        weekdayLabel.textContent = "";
        return;
      }
      const [year, month, day] = value.split("-").map(Number);
      const date = new Date(year, month - 1, day);
      const names = ["일", "월", "화", "수", "목", "금", "토"];
      weekdayLabel.textContent = `${names[date.getDay()]}요일`;
      weekdayLabel.classList.toggle("saturday", date.getDay() === 6);
      weekdayLabel.classList.toggle(
        "holiday",
        holidays.has(value) || date.getDay() === 0
      );
    };

    const moveDate = (delta) => {
      if (!dateInput || !dateInput.value) return;
      const [year, month, day] = dateInput.value.split("-").map(Number);
      const date = new Date(year, month - 1, day);
      date.setDate(date.getDate() + delta);
      dateInput.value = getLocalDateString(date);
      applyDateChange(dateInput.value);
      saveDraft();
    };

    if (dateInput) {
      const initialDate = getLocalDateString();
      dateInput.value = initialDate;
      applyDateChange(dateInput.value);
      dateInput.addEventListener("change", () => {
        applyDateChange(dateInput.value);
        saveDraft();
      });
    }

    if (prevBtn) {
      prevBtn.addEventListener("click", () => moveDate(-1));
    }
    if (nextBtn) {
      nextBtn.addEventListener("click", () => moveDate(1));
    }

    const renderOffList = () => {
      if (!offList) return;
      const raw = localStorage.getItem("dongteukDrivers");
      const list = raw ? JSON.parse(raw) : [];
      const selected = new Set(
        Array.from(document.querySelectorAll('[data-field="driver"]'))
          .map((el) => (el instanceof HTMLSelectElement ? el.value : ""))
          .filter(Boolean)
      );
      const miscNames = new Set(getMiscNames());
      const names = list
        .filter((item) => (item.status || "근무") === "근무")
        .map((item) => item.name)
        .filter((name) => !selected.has(name) && !miscNames.has(name))
        .filter(Boolean);
      offList.textContent = `휴무자: ${names.length ? names.join(", ") : "-"}`;
    };

    renderOffList();

    const driverChannel = new BroadcastChannel("dongteuk-sync");
    driverChannel.addEventListener("message", (event) => {
      if (event.data && event.data.key === "dongteukDrivers") {
        renderOffList();
        document.querySelectorAll("#dispatch-body tr").forEach((row) => {
          updateVehicleOptions(row);
        });
        updateDriverDuplicates();
      }
    });

    const initColumnResize = () => {
      const table = document.getElementById("dispatch-table");
      if (!table) return;
      const cols = table.querySelectorAll("colgroup col");
      const headers = table.querySelectorAll("thead th");
      if (cols.length !== headers.length) return;

      headers.forEach((th, index) => {
        if (index === headers.length - 1) return;
        const resizer = document.createElement("div");
        resizer.className = "col-resizer";
        th.appendChild(resizer);

        let startX = 0;
        let startWidth = 0;

        const onMouseMove = (event) => {
          const delta = event.clientX - startX;
          const newWidth = Math.max(60, startWidth + delta);
          cols[index].style.width = `${newWidth}px`;
        };

        const onMouseUp = () => {
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
        };

        resizer.addEventListener("mousedown", (event) => {
          event.preventDefault();
          startX = event.clientX;
          startWidth = th.getBoundingClientRect().width;
          cols[index].style.width = `${startWidth}px`;
          document.addEventListener("mousemove", onMouseMove);
          document.addEventListener("mouseup", onMouseUp);
        });
      });
    };

    initColumnResize();

    let draggingRow = null;
    body.addEventListener("dragstart", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const handle = target.closest(".drag-handle");
      if (!handle) return;
      const row = handle.closest("tr");
      if (!row) return;
      draggingRow = row;
      row.classList.add("dragging");
      if (event.dataTransfer) {
        event.dataTransfer.setData("text/plain", "");
        event.dataTransfer.effectAllowed = "move";
      }
    });

    body.addEventListener("dragend", () => {
      if (draggingRow) {
        draggingRow.classList.remove("dragging");
      }
      draggingRow = null;
    });

    body.addEventListener("dragover", (event) => {
      event.preventDefault();
      if (!draggingRow) return;
      const row = event.target.closest("tr");
      if (!row || row === draggingRow) return;
      const rect = row.getBoundingClientRect();
      const after = event.clientY > rect.top + rect.height / 2;
      body.insertBefore(draggingRow, after ? row.nextSibling : row);
    });

    document.addEventListener("change", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLSelectElement)) return;
      if (target.dataset.field === "product") {
        const row = target.closest("tr");
        if (row) {
          updateVehicleOptions(row);
        }
      }
      if (target.dataset.field === "vehicle") {
        const value = target.value;
        if (value) {
          const rows = Array.from(body.querySelectorAll("tr"));
          const duplicates = rows.filter((row) => {
            const select = row.querySelector('[data-field="vehicle"]');
            return select instanceof HTMLSelectElement && select.value === value;
          });
          if (duplicates.length > 1) {
            const proceed = confirm("중복배차하시겠습니까?");
            if (!proceed) {
              target.value = "";
            }
          }
        }
        const row = target.closest("tr");
        if (row) {
          updateVehicleOptions(row);
        }
      }
      if (target.dataset.field === "driver") {
        const value = target.value;
        if (value) {
          const rows = Array.from(body.querySelectorAll("tr"));
          const duplicates = rows.filter((row) => {
            const select = row.querySelector('[data-field="driver"]');
            return select instanceof HTMLSelectElement && select.value === value;
          });
          if (duplicates.length > 1) {
            const proceed = confirm("중복배차하시겠습니까?");
            if (!proceed) {
              target.value = "";
            }
          }
        }
        updateDriverDuplicates();
        renderOffList();
        document.querySelectorAll("#dispatch-body tr").forEach((row) => {
          updateVehicleOptions(row);
        });
      }
      if (target.dataset.field === "tractor") {
        const value = target.value;
        if (value) {
          const rows = Array.from(body.querySelectorAll("tr"));
          const duplicates = rows.filter((row) => {
            const select = row.querySelector('[data-field="tractor"]');
            return select instanceof HTMLSelectElement && select.value === value;
          });
          if (duplicates.length > 1) {
            const proceed = confirm("중복배차하시겠습니까?");
            if (!proceed) {
              target.value = "";
            }
          }
        }
        updateTractorHighlights();
      }
      if (target.dataset.field === "prevday") {
        const row = target.closest("tr");
        if (row) {
          const custom = row.querySelector('[data-field="prevdayCustom"]');
          if (custom instanceof HTMLInputElement) {
            const useCustom = target.value === "기타직접입력";
            custom.disabled = !useCustom;
            custom.style.display = useCustom ? "block" : "none";
            if (!useCustom) {
              custom.value = "";
            }
          }
        }
      }
      if (target.dataset.field === "finalPurchase") {
        const row = target.closest("tr");
        if (row) {
          const custom = row.querySelector('[data-field="finalPurchaseCustom"]');
          if (custom instanceof HTMLInputElement) {
            const useCustom = target.value === "기타직접입력";
            custom.disabled = !useCustom;
            custom.style.display = useCustom ? "block" : "none";
            if (!useCustom) {
              custom.value = "";
            }
          }
        }
      }
    });

    const channel = new BroadcastChannel("dongteuk-sync");
    channel.addEventListener("message", (event) => {
      if (event.data && event.data.key === "dongteukVehicles") {
        document.querySelectorAll("#dispatch-body tr").forEach((row) => {
          updateVehicleOptions(row);
        });
      }
    });

    body.addEventListener("input", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLInputElement || target instanceof HTMLElement)) return;
      if (target.dataset.field || target.classList.contains("misc-input")) {
        saveDraft();
        if (target.classList.contains("misc-input")) {
          renderOffList();
        }
        if (target.dataset.field === "availability") {
          const row = target.closest("tr");
          const vehicleInput = row?.querySelector('[data-field="vehicle"]');
          const vehicle = vehicleInput instanceof HTMLInputElement
            ? vehicleInput.value.trim()
            : vehicleInput instanceof HTMLSelectElement
              ? vehicleInput.value.trim()
              : "";
          if (vehicle) {
            updateVehicleFeature(vehicle, target.value.trim());
          }
        }
        if (target.classList.contains("task-edit")) {
          const row = target.closest("tr");
          const vehicleInput = row?.querySelector('[data-field="vehicle"]');
          const vehicle = vehicleInput instanceof HTMLInputElement
            ? vehicleInput.value.trim()
            : vehicleInput instanceof HTMLSelectElement
              ? vehicleInput.value.trim()
              : "";
          if (vehicle) {
            const vehicles = readVehicles();
            const found = vehicles.find((item) => item.number === vehicle);
            const feature = (found?.feature || "").trim();
            const taskText = target.textContent || "";
            const warned = row?.dataset.warnedForbiddenKeywords
              ? new Set(row.dataset.warnedForbiddenKeywords.split("|"))
              : new Set();
            const matches = [];
            const normalizedFeature = feature.replace(/\s*,\s*/g, ",");
            const pattern = /([^\s/]+?)\s*금지/g;
            let match = null;
            while ((match = pattern.exec(normalizedFeature))) {
              const raw = match[1] || "";
              const keywords = raw.split(",").map((item) => item.trim()).filter(Boolean);
              keywords.forEach((keyword) => {
                if (taskText.includes(keyword) && !warned.has(keyword)) {
                  matches.push(keyword);
                  warned.add(keyword);
                }
              });
            }
            if (matches.length) {
              row.dataset.warnedForbiddenKeywords = Array.from(warned).join("|");
              alert(`해당 차량 특징에 '${matches.join(", ")}' 금지가 있습니다. 작업 입력 전에 확인해 주세요.`);
            }
          }
        }
      }
    });

    body.addEventListener("change", () => {
      saveDraft();
    });

    miscInputs.forEach((input) => {
      if (input) {
        input.addEventListener("input", () => {
          saveDraft();
          renderOffList();
        });
        input.addEventListener("compositionend", () => {
          saveDraft();
          renderOffList();
        });
        input.addEventListener("change", () => {
          saveDraft();
          renderOffList();
        });
      }
    });
    if (supportPhone) {
      supportPhone.addEventListener("change", saveDraft);
    }
    if (supportSystem) {
      supportSystem.addEventListener("change", saveDraft);
    }

    const adminChannel = new BroadcastChannel("dongteuk-sync");
    adminChannel.addEventListener("message", (event) => {
      if (event.data && event.data.key === "dongteukDrivers") {
        fillSupportAdmins();
      }
    });

    const taskToolbar = document.getElementById("task-toolbar");
    const taskBold = document.getElementById("task-bold");
    const taskColor = document.getElementById("task-color");

    const isSelectionInsideTask = () => {
      const selection = window.getSelection();
      if (!selection || selection.rangeCount === 0) return false;
      const range = selection.getRangeAt(0);
      const container = range.commonAncestorContainer;
      const element = container.nodeType === 1 ? container : container.parentElement;
      return Boolean(element && element.closest(".task-edit"));
    };

    const positionToolbar = () => {
      if (!taskToolbar) return;
      const selection = window.getSelection();
      if (!selection || selection.rangeCount === 0) return;
      const range = selection.getRangeAt(0);
      const rect = range.getBoundingClientRect();
      if (!rect || !rect.width) return;
      taskToolbar.style.left = `${window.scrollX + rect.left}px`;
      taskToolbar.style.top = `${window.scrollY + rect.top - 36}px`;
    };

    const updateToolbarState = () => {
      if (!taskBold) return;
      const isBold = document.queryCommandState("bold");
      taskBold.classList.toggle("active", isBold);
    };

    const showToolbar = () => {
      if (!taskToolbar) return;
      taskToolbar.style.display = "inline-flex";
      positionToolbar();
      updateToolbarState();
    };

    const hideToolbar = () => {
      if (!taskToolbar) return;
      taskToolbar.style.display = "none";
    };

    document.addEventListener("selectionchange", () => {
      const selection = window.getSelection();
      if (!selection || selection.isCollapsed || !isSelectionInsideTask()) {
        hideToolbar();
        return;
      }
      showToolbar();
    });

    document.addEventListener("scroll", () => {
      if (taskToolbar && taskToolbar.style.display === "inline-flex") {
        positionToolbar();
      }
    });

    document.addEventListener("mousedown", (event) => {
      if (!taskToolbar) return;
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      if (target.closest(".task-toolbar") || target.closest(".task-edit")) return;
      hideToolbar();
    });

    if (taskBold) {
      taskBold.addEventListener("click", () => {
        document.execCommand("bold");
        updateToolbarState();
      });
    }

    if (taskColor) {
      taskColor.addEventListener("change", () => {
        const value = taskColor.value;
        if (value) {
          document.execCommand("foreColor", false, value);
        }
        taskColor.value = "";
      });
    }
  
    const renderLoginMeta = () => {
      const userEl = document.getElementById("login-user");
      const timeEl = document.getElementById("login-time");
      if (!userEl || !timeEl) return;

      const currentUser = (localStorage.getItem("dongteukCurrentUser") || "").trim();
      let displayName = currentUser || "-";
      let displayTitle = "";
      try {
        const drivers = JSON.parse(localStorage.getItem("dongteukDrivers") || "[]");
        const found = drivers.find((item) => (item.name || "").trim() === currentUser);
        if (found) {
          displayName = found.name || displayName;
          displayTitle = found.title || "";
        }
      } catch (error) {
      }
      const titleText = displayTitle ? ` ${displayTitle}` : "";
      userEl.textContent = `${displayName}${titleText}`;

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      const hh = String(now.getHours()).padStart(2, "0");
      const mi = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");
      timeEl.textContent = `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    };

    renderLoginMeta();
    setInterval(renderLoginMeta, 1000);</script>
  <script>
    // admin-menu-guard
    (() => {
      const currentUser = (localStorage.getItem("dongteukCurrentUser") || "").trim();
            const role = (localStorage.getItem("dongteukCurrentRole") || "").trim();
      let isAdmin = role === "admin" || role === "관리자";
      if (currentUser) {
        try {
          const drivers = JSON.parse(localStorage.getItem("dongteukDrivers") || "[]");
          const found = drivers.find((item) => (item.name || "").trim() === currentUser);
          isAdmin = Boolean(found && found.status === "관리자");
        } catch (error) {
          isAdmin = false;
        }
      }
      if (isAdmin) { document.body.classList.add("is-admin"); return; }
      const targets = document.querySelectorAll(
        'a[href="register-info.html"], a[href="dispatch-create.html"], a[href="office-work.html"]'
      );
      targets.forEach((el) => {
        el.style.display = "none";
        el.setAttribute("aria-hidden", "true");
        el.tabIndex = -1;
      });
    })();
  </script>

</html>














































